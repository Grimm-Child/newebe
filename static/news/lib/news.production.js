(function(){var m,n,i,j,k,l,f,g,d,q=Object.prototype.hasOwnProperty,h=function(b,a){function c(){this.constructor=b}for(var e in a)if(q.call(a,e))b[e]=a[e];c.prototype=a.prototype;b.prototype=new c;b.__super__=a.prototype;return b};(function(){function b(){var a;a=document.createElement("div");a.id="info-dialog";a.className="dialog";a.innerHTML="Test";$("body").prepend(a);this.element=$("#info-dialog");this.element.hide()}b.prototype.display=function(a){this.element.empty();this.element.append(a);
this.element.show();return this.element.fadeOut(4E3)};return b})();m=function(){function b(){var a;a=document.createElement("div");a.id="confirmation-dialog";a.className="dialog";a.innerHTML='<div id="confirmation-text"></div>';a.innerHTML+='<div id="confirmation-buttons"><span href="" id="confirmation-yes">Yes</span><span href="" id="confirmation-no">No</span></div>';$("body").prepend(a);this.element=$("#confirmation-dialog");this.element.hide();this.setNoButton()}b.prototype.setNoButton=function(){var a;
a=this.element;return $("#confirmation-no").click(function(){a.fadeOut();return false})};b.prototype.display=function(a,c){$("#confirmation-text").empty();$("#confirmation-text").append("<span>"+a+"</span>");$("#confirmation-yes").click(c);return this.element.show()};b.prototype.hide=function(){return this.element.fadeOut()};return b}();n=function(){function b(){var a;a=document.createElement("div");a.id="loading-indicator";a.innerHTML='<img src="/static/images/clock_32.png" />';$("body").prepend(a);
this.element=$("#loading-indicator");this.element.hide()}b.prototype.display=function(){return this.element.show()};b.prototype.hide=function(){return this.element.hide()};return b}();i=function(){function b(a){var c;b.__super__.constructor.apply(this,arguments);this.set("author",a.author);this.set("authorKey",a.authorKey);this.set("micropostId",a._id);this.set("content",a.content);this.id=a._id;c=a.content.replace(/<(?:.|\s)*?>/g,"");c=(new Showdown.converter).makeHtml(c);this.set("contentHtml",
c);this.attributes.contentHtml=c;if(a.date){c=Date.parseExact(a.date,"yyyy-MM-ddTHH:mm:ssZ");c=c.toString("yyyy-MM-dd-HH-mm-ss/");this.attributes.urlDate=c}}h(b,Backbone.Model);b.prototype.url="/news/microposts/";b.prototype.getDisplayDate=function(){return this.attributes.displayDate};b.prototype.setDisplayDate=function(){return this.setDisplayDateFromDbDate(this.attributes.date)};b.prototype.setDisplayDateFromDbDate=function(a){a=Date.parseExact(a,"yyyy-MM-ddTHH:mm:ssZ");this.attributes.displayDate=
a.toString("dd MMM yyyy, HH:mm");return a};b.prototype.getUrlDate=function(){return this.attributes.urlDate};b.prototype.getAuthor=function(){return this.get("author")};b.prototype.getAuthorKey=function(){return this.get("authorKey")};b.prototype.getDate=function(){return this.get("date")};b.prototype.getContent=function(){return this.get("content")};b.prototype["delete"]=function(){this.url+=this.id;this.destroy();return this.view.remove()};b.prototype.isNew=function(){return!this.getAuthor()};return b}();
j=function(){function b(){b.__super__.constructor.apply(this,arguments)}h(b,Backbone.Collection);b.prototype.model=i;b.prototype.url="/news/microposts/all/";b.prototype.comparator=function(a){return a.getDate()};b.prototype.parse=function(a){return a.rows};return b}();k=function(){function b(a){this.model=a;b.__super__.constructor.apply(this,arguments);this.id=this.model.id;this.model.view=this}h(b,Backbone.View);b.prototype.tagName="div";b.prototype.className="news-micropost-row";b.prototype.template=
_.template('<a class="news-micropost-delete">X</a>\n<a href="#" class="news-micropost-author"><%= author %></a>\n<%= contentHtml %>\n<p class="news-micropost-date">\n <%= displayDate %>     \n</p>');b.prototype.events={"click .news-micropost-delete":"onDeleteClicked",mouseover:"onMouseOver",mouseout:"onMouseOut","click .news-micropost-author":"onAuthorClicked"};b.prototype.onMouseOver=function(){return this.$(".news-micropost-delete").show()};b.prototype.onMouseOut=function(){return this.$(".news-micropost-delete").hide()};
b.prototype.onDeleteClicked=function(){var a;a=this.model;return l.display("Are you sure you want to delete this post ?",function(){l.hide();return a["delete"]()})};b.prototype.onAuthorClicked=function(a){$.get("/contacts/render/"+this.model.getAuthorKey()+"/",function(c){return $("#news-preview").html(c)});a.preventDefault();return false};b.prototype.remove=function(){return $(this.el).remove()};b.prototype.render=function(){this.model.getDisplayDate()||this.model.setDisplayDate();$(this.el).html(this.template(this.model.toJSON()));
this.$(".news-micropost-delete").button();this.$(".news-micropost-delete").hide();return this.el};return b}();g=new (function(){function b(){b.__super__.constructor.apply(this,arguments)}h(b,Backbone.View);b.prototype.el=$("#news");b.prototype.isCtrl=false;b.prototype.events={"click #news-post-button":"onPostClicked","submit #news-post-button":"onPostClicked","click #news-my-button":"onMineClicked","click #news-all-button":"onAllClicked","click #news-more":"onMoreNewsClicked"};b.prototype.initialize=
function(){_.bindAll(this,"postNewPost","appendOne","prependOne","addAll");_.bindAll(this,"displayMyNews","onMoreNewsClicked","addAllMore");_.bindAll(this,"onDatePicked");this.tutorialOn=true;this.microposts=new j;this.microposts.bind("add",this.prependOne);this.microposts.bind("refresh",this.addAll);this.moreMicroposts=new j;this.moreMicroposts.bind("refresh",this.addAllMore);return this.currentPath="/news/microposts/all/"};b.prototype.onKeyUp=function(a){if(a.keyCode===17)this.isCtrl=false;return a};
b.prototype.onKeyDown=function(a){if(a.keyCode===17)this.isCtrl=true;if(a.keyCode===13&&this.isCtrl){this.isCtrl=false;this.postNewPost()}return a};b.prototype.onPostClicked=function(a){a.preventDefault();this.postNewPost();return a};b.prototype.onMineClicked=function(a){$("#news-my-button").button("disable");$("#news-all-button").button("enable");this.clearNews(null);$("#news-from-datepicker").val(null);this.currentPath="/news/microposts/mine/";this.reloadMicroPosts(null);return a};b.prototype.onAllClicked=
function(a){$("#news-all-button").button("disable");$("#news-my-button").button("enable");this.clearNews(null);$("#news-from-datepicker").val(null);this.currentPath="/news/microposts/all/";this.reloadMicroPosts(null);return a};b.prototype.onDatePicked=function(a){a=Date.parse(a).toString("yyyy-MM-dd");this.clearNews();return this.reloadMicroPosts(a)};b.prototype.clearNews=function(){$("#micro-posts").empty();return $("#news-more").show()};b.prototype.addAllMore=function(){var a;a=this.moreMicroposts.toArray().reverse();
a=_.rest(a);_.each(a,this.appendOne);this.lastDate=this.moreMicroposts.last().getUrlDate();a.length<10&&$("#news-more").hide();f.hide();return this.lastDate};b.prototype.addAll=function(){if(this.microposts.length>0){this.tutorialOn=false;this.lastDate=this.microposts.first().getUrlDate();this.microposts.length<10&&$("#news-more").hide()}else{this.tutorialOn?this.displayTutorial(1):$("#tutorial").html(null);$("#news-more").hide()}this.microposts.each(this.prependOne);f.hide();return this.microposts.length};
b.prototype.appendOne=function(a){var c;c=new k(a);a=c.render();$("#micro-posts").append(a);return c};b.prototype.prependOne=function(a){var c;c=new k(a);a=c.render();$("#micro-posts").prepend(a);f.hide();if(this.tutorialOn){this.displayTutorial(2);this.tutorialOn=false}return c};b.prototype.displayTutorial=function(a){return $.get("/news/tutorial/"+a+"/",function(c){return $("#tutorial-news").html(c)})};b.prototype.clearPostField=function(){$("#id_content").val(null);$("#id_content").focus();return $("#id_content")};
b.prototype.reloadMicroPosts=function(a){f.display();this.microposts.url=this.currentPath;if(a)this.microposts.url=this.currentPath+a+"-23-59-00/";this.microposts.fetch();return this.microposts};b.prototype.fetch=function(){this.microposts.fetch();return this.microposts};b.prototype.postNewPost=function(){var a,c,e;f.display();a=$("#id_content").val();c=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;if(e=a.match(c)){e=e[0];a=a.replace(c,"["+e+"]("+e+")")}this.microposts.create({content:a},
{success:function(o,p){f.hide();o.view.el.id=p._id;return o.id=p._id}});$("#id_content").val(null);$("#id_content").focus();return false};b.prototype.onMoreNewsClicked=function(){f.display();this.moreMicroposts.url=this.lastDate?this.currentPath+this.lastDate:this.currentPath;this.moreMicroposts.fetch();return this.moreMicroposts};b.prototype.setListeners=function(){$("#id_content").keyup(function(a){return g.onKeyUp(a)});$("#id_content").keydown(function(a){return g.onKeyDown(a)});return $("input#news-from-datepicker").datepicker({onSelect:this.onDatePicked})};
b.prototype.setWidgets=function(){$("input#news-post-button").button();$("#news-my-button").button();$("#news-all-button").button();$("#news-all-button").button("disable");$("#news-more").button();$("#news-from-datepicker").val(null);return $("#news-a").addClass("disabled")};return b}());f=new n;l=new m;g.setWidgets();g.setListeners();g.clearPostField();g.fetch();d={errorSleepTime:500,cursor:null,poll:function(){return $.ajax({url:"/news/suscribe/",type:"GET",dataType:"text",success:d.onSuccess,error:d.onError})},
onSuccess:function(b){var a;try{if(b){a=new i(eval("("+b+")"));g.prependOne(a)}}catch(c){d.onError();return}d.errorSleepTime=500;return window.setTimeout(d.poll,0)},onError:function(){d.errorSleepTime*=2;return window.setTimeout(d.poll,d.errorSleepTime)}};d.poll()}).call(this);
