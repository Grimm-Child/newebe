(function(){var m,n,h,i,j,k,e,f,d,o=Object.prototype.hasOwnProperty,g=function(b,a){function c(){this.constructor=b}for(var l in a)if(o.call(a,l))b[l]=a[l];c.prototype=a.prototype;b.prototype=new c;b.__super__=a.prototype;return b};(function(){function b(){var a;a=document.createElement("div");a.id="info-dialog";a.className="dialog";a.innerHTML="Test";$("body").prepend(a);this.element=$("#info-dialog");this.element.hide()}b.prototype.display=function(a){this.element.empty();this.element.append(a);
this.element.show();return this.element.fadeOut(4E3)};return b})();m=function(){function b(){var a;a=document.createElement("div");a.id="confirmation-dialog";a.className="dialog";a.innerHTML='<div id="confirmation-text"></div>';a.innerHTML+='<div id="confirmation-buttons"><span href="" id="confirmation-yes">Yes</span><span href="" id="confirmation-no">No</span></div>';$("body").prepend(a);this.element=$("#confirmation-dialog");this.element.hide();this.setNoButton()}b.prototype.setNoButton=function(){var a;
a=this.element;return $("#confirmation-no").click(function(){a.fadeOut();return false})};b.prototype.display=function(a,c){$("#confirmation-text").empty();$("#confirmation-text").append("<span>"+a+"</span>");$("#confirmation-yes").click(c);return this.element.show()};b.prototype.hide=function(){return this.element.fadeOut()};return b}();n=function(){function b(){var a;a=document.createElement("div");a.id="loading-indicator";a.innerHTML='<img src="/static/images/clock_32.png" />';$("body").prepend(a);
this.element=$("#loading-indicator");this.element.hide()}b.prototype.display=function(){return this.element.show()};b.prototype.hide=function(){return this.element.hide()};return b}();h=function(){function b(a){var c;b.__super__.constructor.apply(this,arguments);this.set("author",a.author);this.set("content",a.content);this.set("authorKey",a.authorKey);if(a.date){c=this.setDisplayDateFromDbDate(a.date);c=c.toString("yyyy-MM-dd-HH-mm-ss");this.id=c+"/"}}g(b,Backbone.Model);b.prototype.url="/news/microposts/";
b.prototype.getDisplayDate=function(){return this.attributes.displayDate};b.prototype.setDisplayDate=function(){return this.setDisplayDateFromDbDate(this.attributes.date)};b.prototype.setDisplayDateFromDbDate=function(a){a=Date.parseExact(a,"yyyy-MM-ddTHH:mm:ssZ");this.attributes.displayDate=a.toString("dd MMM yyyy, HH:mm");return a};b.prototype.getAuthor=function(){return this.get("author")};b.prototype.getDate=function(){return this.get("date")};b.prototype.getContent=function(){return this.get("content")};
b.prototype["delete"]=function(){this.url+=this.id;this.destroy();return this.view.remove()};b.prototype.isNew=function(){return!this.getAuthor()};return b}();i=function(){function b(){b.__super__.constructor.apply(this,arguments)}g(b,Backbone.Collection);b.prototype.model=h;b.prototype.url="/news/microposts/";b.prototype.comparator=function(a){return a.getDate()};b.prototype.parse=function(a){return a.rows};return b}();j=function(){function b(a){this.model=a;b.__super__.constructor.apply(this,arguments);
this.id="micropost-"+this.model.id;this.model.view=this}g(b,Backbone.View);b.prototype.tagName="div";b.prototype.className="news-micropost-row";b.prototype.template=_.template('<a class="news-micropost-delete">X</a>\n<p class="news-micropost-content">\n <span><%= author %></span>\n <%= content %>\n</p>\n<p class="news-micropost-date">\n <%= displayDate %>\n</p>');b.prototype.events={"click .news-micropost-delete":"onDeleteClicked",mouseover:"onMouseOver",mouseout:"onMouseOut"};b.prototype.onMouseOver=
function(){return this.$(".news-micropost-delete").show()};b.prototype.onMouseOut=function(){return this.$(".news-micropost-delete").hide()};b.prototype.onDeleteClicked=function(){var a;a=this.model;return k.display("Are you sure you want to delete this post ?",function(){k.hide();return a["delete"]()})};b.prototype.remove=function(){return $(this.el).remove()};b.prototype.render=function(){this.model.getDisplayDate()||this.model.setDisplayDate();$(this.el).html(this.template(this.model.toJSON()));
this.$(".news-micropost-delete").button();this.$(".news-micropost-delete").hide();return this.el};return b}();f=new (function(){function b(){b.__super__.constructor.apply(this,arguments)}g(b,Backbone.View);b.prototype.el=$("#news");b.prototype.isCtrl=false;b.prototype.events={"click #news-post-button":"onPostClicked","submit #news-post-button":"onPostClicked","click #news-my-button":"onMineClicked","click #news-more":"onMoreNewsClicked"};b.prototype.initialize=function(){_.bindAll(this,"postNewPost",
"appendOne","prependOne","addAll");_.bindAll(this,"displayMyNews","onMoreNewsClicked","addAllMore");_.bindAll(this,"onDatePicked");this.tutorialOn=true;this.microposts=new i;this.microposts.bind("add",this.prependOne);this.microposts.bind("refresh",this.addAll);this.moreMicroposts=new i;return this.moreMicroposts.bind("refresh",this.addAllMore)};b.prototype.onKeyUp=function(a){if(a.keyCode===17)this.isCtrl=false;return a};b.prototype.onKeyDown=function(a){if(a.keyCode===17)this.isCtrl=true;if(a.keyCode===
13&&this.isCtrl){this.isCtrl=false;this.postNewPost()}return a};b.prototype.onPostClicked=function(a){a.preventDefault();this.postNewPost();return a};b.prototype.onMineClicked=function(a){this.clearNews(null);this.reloadMicroPosts();this.displayMyNews();return a};b.prototype.onDatePicked=function(a){a=Date.parse(a).toString("yyyy-MM-dd");this.clearNews();return this.reloadMicroPosts(a)};b.prototype.clearNews=function(){$("#micro-posts").empty();return $("#news-more").show()};b.prototype.addAllMore=
function(){var a;a=this.moreMicroposts.toArray().reverse();a=_.rest(a);_.each(a,this.appendOne);this.lastDate=this.moreMicroposts.last().id;a.length<10&&$("#news-more").hide();e.hide();return this.lastDate};b.prototype.addAll=function(){if(this.microposts.length>0){this.tutorialOn=false;this.lastDate=this.microposts.first().id;this.microposts.length<10&&$("#news-more").hide()}else{this.tutorialOn?this.displayTutorial(1):$("#tutorial").html(null);$("#news-more").hide()}this.microposts.each(this.prependOne);
e.hide();return this.microposts.length};b.prototype.appendOne=function(a){var c;c=new j(a);a=c.render();$("#micro-posts").append(a);return c};b.prototype.prependOne=function(a){var c;c=new j(a);a=c.render();$("#micro-posts").prepend(a);e.hide();if(this.tutorialOn){this.displayTutorial(2);this.tutorialOn=false}return c};b.prototype.displayTutorial=function(a){return $.get("/news/tutorial/"+a+"/",function(c){return $("#tutorial-news").html(c)})};b.prototype.clearPostField=function(){$("#id_content").val(null);
$("#id_content").focus();return $("#id_content")};b.prototype.reloadMicroPosts=function(a){e.display();this.microposts.url="/news/microposts/";if(a)this.microposts.url="/news/microposts/"+a+"-23-59-00/";this.microposts.fetch();return this.microposts};b.prototype.fetch=function(){this.microposts.fetch();return this.microposts};b.prototype.postNewPost=function(){e.display();this.microposts.create({content:$("#id_content").val()},{success:function(){return e.hide()}});$("#id_content").val(null);$("#id_content").focus();
return false};b.prototype.onMoreNewsClicked=function(){e.display();this.moreMicroposts.url=this.lastDate?"/news/microposts/"+this.lastDate:"/news/microposts/";this.moreMicroposts.fetch();return this.moreMicroposts};b.prototype.setListeners=function(){$("#id_content").keyup(function(a){return f.onKeyUp(a)});$("#id_content").keydown(function(a){return f.onKeyDown(a)});return $("input#news-from-datepicker").datepicker({onSelect:this.onDatePicked})};b.prototype.setWidgets=function(){$("input#news-post-button").button();
$("#news-my-button").button();$("#news-all-button").button();$("#news-all-button").button("disable");$("#news-more").button();$("#news-from-datepicker").val(null);return $("#news-a").addClass("disabled")};return b}());e=new n;k=new m;f.setWidgets();f.setListeners();f.clearPostField();f.fetch();d={errorSleepTime:500,cursor:null,poll:function(){return $.ajax({url:"/news/suscribe/",type:"GET",dataType:"text",success:d.onSuccess,error:d.onError})},onSuccess:function(b){var a;try{if(b){a=new h(eval("("+
b+")"));f.prependOne(a)}}catch(c){d.onError();return}d.errorSleepTime=500;return window.setTimeout(d.poll,0)},onError:function(){d.errorSleepTime*=2;return window.setTimeout(d.poll,d.errorSleepTime)}};d.poll()}).call(this);
