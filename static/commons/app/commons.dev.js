// Generated by CoffeeScript 1.3.3
(function() {
  var Common, CommonCollection, CommonRow, CommonsRouter, CommonsView, ConfirmationDialog, DocumentSelector, InfoDialog, LoadingIndicator, Row, TagCombo, app, commonRouter, confirmationDialog, infoDialog, loadingIndicator, selectorDialogCommon,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  InfoDialog = (function() {

    function InfoDialog() {
      var div;
      if ($("#info-dialog").length === 0) {
        div = document.createElement('div');
        div.id = "info-dialog";
        div.className = "dialog";
        $("body").prepend(div);
      }
      this.element = $("#info-dialog");
      this.element.hide();
    }

    InfoDialog.prototype.display = function(text) {
      this.element.empty();
      this.element.append(text);
      this.element.show();
      return this.element.fadeOut(4000);
    };

    return InfoDialog;

  })();

  ConfirmationDialog = (function() {

    function ConfirmationDialog() {
      var div;
      if ($("#confirmation-dialog").length === 0) {
        div = document.createElement('div');
        div.id = "confirmation-dialog";
        div.className = "dialog";
        div.innerHTML = '<div id="confirmation-text"></div>';
        div.innerHTML += '<div id="confirmation-buttons">' + '<span href="" id="confirmation-yes">Yes</span>' + '<span href="" id="confirmation-no">No</span>' + '</div>';
        $("body").prepend(div);
      }
      this.element = $("#confirmation-dialog");
      this.element.hide();
      this.setNoButton();
    }

    ConfirmationDialog.prototype.setNoButton = function() {
      var divElement;
      divElement = this.element;
      return $("#confirmation-no").click(function() {
        divElement.fadeOut();
        return false;
      });
    };

    ConfirmationDialog.prototype.display = function(text, callback) {
      var left, top;
      $("#confirmation-text").empty();
      $("#confirmation-text").append('<span>' + text + '</span>');
      $("#confirmation-yes").click(callback);
      this.element.show();
      top = $("body").scrollTop() + 200;
      left = this.element.offset().left;
      return this.element.offset({
        left: left,
        top: top
      });
    };

    ConfirmationDialog.prototype.hide = function() {
      return this.element.fadeOut();
    };

    return ConfirmationDialog;

  })();

  LoadingIndicator = (function() {

    function LoadingIndicator() {
      var div;
      if ($("#loading-indicator").length === 0) {
        div = document.createElement('div');
        div.id = "loading-indicator";
        div.innerHTML = '<img src="/static/images/clock_32.png" alt="loading indicator" />';
        $("body").prepend(div);
      }
      this.element = $("#loading-indicator");
      this.element.hide();
    }

    LoadingIndicator.prototype.display = function() {
      return this.element.show();
    };

    LoadingIndicator.prototype.hide = function() {
      return this.element.hide();
    };

    return LoadingIndicator;

  })();

  DocumentSelector = (function() {

    function DocumentSelector() {
      this.onDatePicked = __bind(this.onDatePicked, this);
      if ($("#document-selector") === void 0 || $("#document-selector").length === 0) {
        this.createWidget();
        this.setListeners();
      } else {
        this.element = $("#document-selector");
      }
      this.docList = $("#document-selector-list");
      this.element.hide();
    }

    DocumentSelector.prototype.createWidget = function() {
      var div;
      div = document.createElement('div');
      div.id = "document-selector";
      div.className = "dialog";
      $("body").prepend(div);
      this.element = $("#document-selector");
      return this.element.html('<div id="document-selector-buttons" class="dialog-buttons">\n  <span id="document-selector-select">Select</span>\n  <span id="document-selector-cancel">Cancel</span>\n</div>\n<div id="document-selector-toolbar">\n<div class="document-selector-select-wrapper">\n<select id="document-selector-type">\n    <option label="Note" value="1">Note</option>\n    <option label="Picture" value="1">Picture</option>\n</select>\n</div>\n<span id="document-selector-datepicker-label">until </span>\n<input type="text" id="document-selector-datepicker" />\n</div>\n<div id="document-selector-list">\n</div>');
    };

    DocumentSelector.prototype.setListeners = function() {
      var _this = this;
      $("#document-selector-datepicker").datepicker({
        onSelect: this.onDatePicked
      });
      $("#document-selector-datepicker").hide();
      $("#document-selector-datepicker-label").hide();
      $("#document-selector-cancel").click(function() {
        return _this.element.fadeOut(400);
      });
      return $("#document-selector-type").change(function(event) {
        var type;
        type = $("#document-selector-type :selected").text();
        if (type === "Picture") {
          $("#document-selector-datepicker").show();
          $("#document-selector-datepicker-label").show();
          return _this.loadPictures();
        } else if (type === "Note") {
          $("#document-selector-datepicker").hide();
          $("#document-selector-datepicker-label").hide();
          return _this.loadNotes();
        }
      });
    };

    DocumentSelector.prototype.display = function(types, callback) {
      this.setSelectDocListener(callback);
      $("#document-selector-type").val("Note");
      $("#document-selector-datepicker").hide();
      $("#document-selector-datepicker-label").hide();
      if (types.length === 1) {
        $("#document-selector-type").val(types[0]);
        $("#document-selector-toolbar").hide();
      } else {
        $("#document-selector-toolbar").show();
      }
      this.loadNotes();
      return this.element.fadeIn(400);
    };

    DocumentSelector.prototype.setSelectDocListener = function(callback) {
      var _this = this;
      if (this.fun !== void 0) {
        $("#document-selector-select").unbind("click", this.fun);
      }
      this.fun = function(event) {
        if ($("#document-selector-list .selected")) {
          callback({
            id: $("#document-selector-list .selected")[0].id,
            type: $("#document-selector-type :selected").text()
          });
        }
        return _this.element.fadeOut(400);
      };
      return $("#document-selector-select").click(this.fun);
    };

    DocumentSelector.prototype.onDatePicked = function(dateText, event) {
      var d, sinceDate,
        _this = this;
      d = Date.parse(dateText);
      sinceDate = d.toString("yyyy-MM-dd");
      return $.get("/pictures/all/" + sinceDate + "-00-00-00/html/", function(data) {
        _this.docList.html(data);
        _this.setupList("picture-row");
        if (typeof callback !== "undefined" && callback !== null) {
          return callback();
        }
      });
    };

    DocumentSelector.prototype.loadNotes = function() {
      var _this = this;
      return $.get("/notes/all/html/", function(data) {
        _this.docList.html(data);
        _this.setupList("note-row");
        return _this.element.fadeIn(400);
      });
    };

    DocumentSelector.prototype.loadPictures = function() {
      var _this = this;
      return $.get("/pictures/all/html/", function(data) {
        _this.docList.html(data);
        return _this.setupList("picture-row");
      });
    };

    DocumentSelector.prototype.setupList = function(className) {
      var selected;
      $("." + className).mouseenter(function(event) {
        return $(this).addClass("mouseover mouseover-dialog");
      });
      $("." + className).mouseleave(function(event) {
        return $(this).removeClass("mouseover mouseover-dialog");
      });
      selected = null;
      return $("." + className).click(function(event) {
        if (selected) {
          selected.removeClass("selected selected-dialog");
        }
        $(this).addClass("selected selected-dialog");
        return selected = $(this);
      });
    };

    return DocumentSelector;

  })();

  Row = (function(_super) {

    __extends(Row, _super);

    function Row() {
      return Row.__super__.constructor.apply(this, arguments);
    }

    Row.prototype.updatePreviewPosition = function() {
      var left, top;
      top = $("body").scrollTop();
      if (top > 50) {
        top = top + 20;
      } else {
        top = top + 60;
      }
      left = this.preview.offset().left;
      return this.preview.offset({
        left: left,
        top: top
      });
    };

    return Row;

  })(Backbone.View);

  $.putJson = function(options) {
    return $.ajax({
      type: "PUT",
      url: options.url,
      dataType: "json",
      data: JSON.stringify(options.body),
      success: options.success,
      error: options.error
    });
  };

  TagCombo = (function(_super) {

    __extends(TagCombo, _super);

    TagCombo.prototype.el = "input";

    function TagCombo(el) {
      TagCombo.__super__.constructor.call(this);
      this.tags = [];
      this.element = el;
    }

    TagCombo.prototype.fetch = function(callback) {
      var _this = this;
      return $.get("/contacts/tags/", function(data) {
        _this.element.html(null);
        _.forEach(data.rows, function(tag) {
          if (tag !== "all") {
            return _this.element.append("<option>" + tag + "</option>");
          } else {
            return _this.element.append("<option selected=\"selected\">" + tag + "</option>");
          }
        });
        return callback("all");
      });
    };

    TagCombo.prototype.getSelection = function() {
      return this.element.val();
    };

    return TagCombo;

  })(Backbone.View);

  CommonsView = (function(_super) {

    __extends(CommonsView, _super);

    CommonsView.prototype.el = $("#commons");

    /* Events
    */


    CommonsView.prototype.events = {
      "click #commons-more-button": "onMoreClicked"
    };

    function CommonsView() {
      this.displayAllCommons = __bind(this.displayAllCommons, this);

      this.displayMyCommons = __bind(this.displayMyCommons, this);

      this.fetchData = __bind(this.fetchData, this);

      this.reloadCommons = __bind(this.reloadCommons, this);

      this.prependOne = __bind(this.prependOne, this);

      this.appendOne = __bind(this.appendOne, this);

      this.addAllMore = __bind(this.addAllMore, this);

      this.addAll = __bind(this.addAll, this);

      this.onTagChanged = __bind(this.onTagChanged, this);

      this.onFileUploadComplete = __bind(this.onFileUploadComplete, this);

      this.onFileSubmitted = __bind(this.onFileSubmitted, this);

      this.onDatePicked = __bind(this.onDatePicked, this);

      this.onRowClicked = __bind(this.onRowClicked, this);

      this.onMoreClicked = __bind(this.onMoreClicked, this);
      CommonsView.__super__.constructor.call(this);
    }

    CommonsView.prototype.initialize = function() {
      this.commons = new CommonCollection;
      this.moreCommons = new CommonCollection;
      this.commons.bind('add', this.prependOne);
      this.commons.bind('reset', this.addAll);
      this.moreCommons.bind('reset', this.addAllMore);
      this.currentPath = "/commons/all/";
      return this.selectedRow = null;
    };

    /* Listeners
    */


    CommonsView.prototype.onMoreClicked = function() {
      this.moreCommons.url = this.currentPath + this.lastDate + "/";
      this.moreCommons.url += "tags/" + this.currentTag + "/";
      return this.moreCommons.fetch();
    };

    CommonsView.prototype.onRowClicked = function(row) {
      if (row !== this.selectedRow) {
        if (this.selectedRow) {
          this.selectedRow.deselect();
        }
        row.select();
        return this.selectedRow = row;
      }
    };

    CommonsView.prototype.onDatePicked = function(dateText, event) {
      var date, datePicked;
      datePicked = Date.parse(dateText);
      date = datePicked.toString("yyyy-MM-dd");
      if (this.currentPath === "/commons/mine/") {
        return Backbone.history.navigate("commons/mine/until/" + date + "/", true);
      } else {
        return Backbone.history.navigate("commons/all/until/" + date + "/", true);
      }
    };

    CommonsView.prototype.onFileSubmitted = function(id, fileName) {
      return loadingIndicator.display();
    };

    CommonsView.prototype.onFileUploadComplete = function(id, fileName, responseJSON) {
      var common, row, rowEl;
      loadingIndicator.hide();
      common = new Common(responseJSON);
      row = new CommonRow(common, this);
      rowEl = row.render();
      $(rowEl).hide();
      $(row.render()).prependTo(this.commonList).slideDown();
      return this.onRowClicked(row);
    };

    CommonsView.prototype.onTagChanged = function() {
      $("#common-list").html(null);
      $("#commons-preview").html(null);
      this.currentTag = this.tagCombo.getSelection();
      this.uploader.setParams({
        tag: this.currentTag
      });
      this.datepicker.val(null);
      return this.reloadCommons(null);
    };

    /* Functions
    */


    CommonsView.prototype.addAll = function() {
      var common;
      if (this.commons.length >= 0 && this.commons.length < 10) {
        this.moreButton.hide();
      } else {
        common = this.commons.first();
        this.lastDate = common.getUrlDate();
        this.moreButton.show();
      }
      this.commons.each(this.prependOne);
      loadingIndicator.hide();
      return this.commons.length;
    };

    CommonsView.prototype.addAllMore = function() {
      var common, commons;
      commons = this.moreCommons.toArray().reverse();
      commons = _.rest(commons);
      if (this.moreCommons.length >= 0 && this.moreCommons.length < 10) {
        this.moreButton.hide();
      } else {
        common = this.moreCommons.last();
        this.lastDate = common.getUrlDate();
        this.moreButton.show();
      }
      _.each(commons, this.appendOne);
      loadingIndicator.hide();
      return this.moreCommons.length;
    };

    CommonsView.prototype.appendOne = function(common) {
      var el, row;
      row = new CommonRow(common, this);
      el = row.render();
      this.commonList.append(el);
      return row;
    };

    CommonsView.prototype.prependOne = function(common) {
      var el, row;
      row = new CommonRow(common, this);
      el = row.render();
      this.commonList.prepend(el);
      return row;
    };

    CommonsView.prototype.reloadCommons = function(date) {
      var _this = this;
      this.commonList.empty();
      this.selectedRow = null;
      loadingIndicator.display();
      if (!(date != null)) {
        date = (new Date()).toString("yyyy-MM-dd");
      }
      this.commons.url = this.currentPath;
      this.commons.url += date + '-23-59-00/';
      this.commons.url += "tags/" + this.currentTag + "/";
      this.commons.fetch({
        error: function() {
          alert("An error occured while retrieving commons");
          loadingIndicator.hide();
          return _this.moreButton.hide();
        }
      });
      return this.commons;
    };

    CommonsView.prototype.fetchData = function() {
      var _this = this;
      this.selectedRow = null;
      this.tagCombo.fetch(function(tag) {
        _this.currentTag = tag;
        _this.uploader.setParams({
          tag: _this.currentTag
        });
        return _this.reloadCommons(date);
      });
      return this.commons;
    };

    CommonsView.prototype.displayMyCommons = function(date) {
      this.myButton.button("disable");
      this.allButton.button("enable");
      this.currentPath = "/commons/mine/";
      this.datepicker.val(date);
      return this.reloadCommons(date);
    };

    CommonsView.prototype.displayAllCommons = function(date) {
      var _this = this;
      this.myButton.button("enable");
      this.allButton.button("disable");
      this.currentPath = "/commons/all/";
      this.datepicker.val(date);
      return this.tagCombo.fetch(function(tag) {
        _this.currentTag = tag;
        return _this.reloadCommons(date);
      });
    };

    /* UI Builders
    */


    CommonsView.prototype.setListeners = function() {
      this.datepicker.datepicker({
        onSelect: this.onDatePicked
      });
      return this.tagCombo.element.change(this.onTagChanged);
    };

    CommonsView.prototype.setWidgets = function() {
      this.myButton = $("#commons-my-button");
      this.allButton = $("#commons-all-button");
      this.moreButton = $("#commons-more-button");
      this.datepicker = $("#commons-from-datepicker");
      this.myButton.button();
      this.allButton.button();
      this.allButton.button("disable");
      this.moreButton.button();
      this.datepicker.val(null);
      this.commonList = $("#commons-list");
      this.tagCombo = new TagCombo($("#commons-tag-combo"));
      return this.uploader = new qq.FileUploader({
        element: document.getElementById('commons-file-uploader'),
        action: '/commons/fileuploader/',
        debug: true,
        onSubmit: this.onFileSubmitted,
        onComplete: this.onFileUploadComplete
      });
    };

    return CommonsView;

  })(Backbone.View);

  CommonRow = (function(_super) {

    __extends(CommonRow, _super);

    CommonRow.prototype.tagName = "div";

    CommonRow.prototype.className = "commons-row";

    CommonRow.prototype.template = _.template('<a href="#" class="commons-picture-author"><%= author %></a>\n<img src="<%= thumbnailPath %>" alt="<%= title %>" />\n<p class="commons-picture-date">\n <%= displayDate %>\n</p>\n<div class="spacer"></div>');

    /* Events
    */


    CommonRow.prototype.events = {
      "mouseover": "onMouseOver",
      "mouseout": "onMouseOut",
      "click": "onClick"
    };

    function CommonRow(model, mainView) {
      this.model = model;
      this.mainView = mainView;
      this.onPushNoteClicked = __bind(this.onPushNoteClicked, this);

      this.onDownloadClicked = __bind(this.onDownloadClicked, this);

      this.onDeleteClicked = __bind(this.onDeleteClicked, this);

      CommonRow.__super__.constructor.call(this);
      this.id = this.model.id;
      this.model.view = this;
      this.selected = false;
      this.preview = $("#commons-preview");
    }

    /* Listeners
    */


    CommonRow.prototype.onMouseOver = function() {
      if (!this.selected) {
        return $(this.el).addClass("mouseover");
      }
    };

    CommonRow.prototype.onMouseOut = function() {
      return $(this.el).removeClass("mouseover");
    };

    CommonRow.prototype.onClick = function() {
      return this.mainView.onRowClicked(this);
    };

    CommonRow.prototype.onDeleteClicked = function(event) {
      var _this = this;
      if (event) {
        event.preventDefault();
      }
      return confirmationDialog.display("Are you sure you want to delete this common ?", function() {
        confirmationDialog.hide();
        _this.model["delete"]();
        _this.mainView.selectedRow = null;
        return _this.preview.fadeOut(function() {
          return _this.preview.html(null);
        });
      });
    };

    CommonRow.prototype.onDownloadClicked = function(event) {
      var _this = this;
      if (event) {
        event.preventDefault();
      }
      loadingIndicator.display();
      return $.get(this.model.getDownloadPath(), function(data) {
        if (data.success) {
          _this.displayPreview();
        } else {
          loadingIndicator.hide();
        }
        return confirmationDialog.display("An error occured while downloading image file.");
      });
    };

    CommonRow.prototype.onPushNoteClicked = function() {
      var _this = this;
      return selectorDialogCommon.display(function(noteId) {
        loadingIndicator.display();
        return $.get("/notes/" + noteId + "/", function(note) {
          note.content = note.content + "\n\n ![image](" + _this.model.getImagePreviewPath() + ")";
          return $.putJson({
            url: "/notes/" + noteId + "/",
            body: note,
            success: function() {
              infoDialog.display("note successfully updated");
              return loadingIndicator.hide();
            },
            error: function() {
              infoDialog.display("note update failed");
              return loadingIndicator.hide();
            }
          });
        });
      });
    };

    /* Functions
    */


    CommonRow.prototype.remove = function() {
      return $(this.el).remove();
    };

    CommonRow.prototype.render = function() {
      $(this.el).html(this.template(this.model.toJSON()));
      return this.el;
    };

    CommonRow.prototype.select = function() {
      $(this.el).removeClass("mouseover");
      $(this.el).addClass("selected");
      return this.displayPreview();
    };

    CommonRow.prototype.deselect = function() {
      return $(this.el).removeClass("selected");
    };

    CommonRow.prototype.displayPreview = function() {
      var _this = this;
      return this.preview.fadeOut(function() {
        _this.preview.html(null);
        return $.get(_this.model.getPath(), function(data) {
          loadingIndicator.hide();
          _this.preview.append(data);
          if ($("#commons-preview img").length > 0) {
            $("#commons-preview").append("            <p class=\"commons-buttons button-bar\">              <a id=\"commons-note-button\">push to note</a>              <a href=\"" + (_this.model.get('imgPath')) + "\"                  target=\"blank\"                 id=\"commons-full-size-button\">full-size</a>              <a id=\"commons-delete-button\">delete</a>            </p>            ");
            $("#commons-note-button").click(_this.onPushNoteClicked);
          }
          $("#commons-delete-button").click(_this.onDeleteClicked);
          $("#commons-download-button").click(_this.onDownloadClicked);
          $("#commons-preview a").button();
          _this.preview.fadeIn();
          return _this.updatePreviewPosition();
        });
      });
    };

    return CommonRow;

  })(Row);

  CommonsRouter = (function(_super) {

    __extends(CommonsRouter, _super);

    CommonsRouter.prototype.routes = {
      "": "all",
      "commons": "all",
      "commons/all/": "all",
      "commons/all/until/:date/": "all",
      "commons/mine/": "mine",
      "commons/mine/until/:date/": "mine",
      "commons/mine/:id/": "mineWithSelection"
    };

    function CommonsRouter(view) {
      CommonsRouter.__super__.constructor.apply(this, arguments);
      this.view = view;
    }

    CommonsRouter.prototype.all = function(date) {
      return this.view.displayAllCommons(date);
    };

    CommonsRouter.prototype.mine = function(date) {
      return this.view.displayMyCommons(date);
    };

    CommonsRouter.prototype.mineWithSelection = function(id) {
      this.view.lastSelectedId = id;
      return this.view.displayMyCommons(null);
    };

    return CommonsRouter;

  })(Backbone.Router);

  Common = (function(_super) {

    __extends(Common, _super);

    Common.prototype.url = '/commons/all/';

    function Common(common) {
      var date;
      Common.__super__.constructor.apply(this, arguments);
      this.set('author', common.author);
      this.set('authorKey', common.authorKey);
      this.set('_id', common._id);
      this.set('path', common.path);
      this.id = common._id;
      this.setImgPath();
      this.setThumbnailPath();
      if (common.date) {
        date = Date.parseExact(common.date, "yyyy-MM-ddTHH:mm:ssZ");
        this.attributes['urlDate'] = date.toString("yyyy-MM-dd-HH-mm-ss");
        this.attributes['displayDate'] = date.toString("dd MMM yyyy, HH:mm");
      }
    }

    /* Getters / Setters
    */


    Common.prototype.getUrlDate = function() {
      return this.attributes['urlDate'];
    };

    Common.prototype.getDisplayDate = function() {
      return this.attributes['displayDate'];
    };

    Common.prototype.setImgPath = function() {
      this.set('imgPath', "/commons/" + this.id + "/" + (this.get('path')));
      return this.attributes['imgPath'] = "/commons/" + this.id + "/" + (this.get('path'));
    };

    Common.prototype.setThumbnailPath = function() {
      this.set('thumnbailPath', "/commons/" + this.id + "/th_" + (this.get('path')));
      return this.attributes['thumbnailPath'] = "/commons/" + this.id + "/th_" + (this.get('path'));
    };

    Common.prototype.getPath = function() {
      return "/commons/" + this.id + "/html/";
    };

    Common.prototype.getDownloadPath = function() {
      return "/commons/" + this.id + "/download/";
    };

    Common.prototype.getImagePreviewPath = function() {
      return "/commons/" + this.id + "/prev_" + (this.get('path'));
    };

    Common.prototype["delete"] = function() {
      this.url = "/commons/" + this.id + "/";
      this.destroy();
      return this.view.remove();
    };

    Common.prototype.isNew = function() {
      return !this.id;
    };

    return Common;

  })(Backbone.Model);

  CommonCollection = (function(_super) {

    __extends(CommonCollection, _super);

    function CommonCollection() {
      return CommonCollection.__super__.constructor.apply(this, arguments);
    }

    CommonCollection.prototype.model = Common;

    CommonCollection.prototype.url = '/commons/all/';

    CommonCollection.prototype.comparator = function(common) {
      var date;
      date = Date.parseExact(common.date, "yyyy-MM-ddTHH:mm:ssZ");
      return date;
    };

    CommonCollection.prototype.parse = function(response) {
      return response.rows;
    };

    return CommonCollection;

  })(Backbone.Collection);

  app = new CommonsView;

  commonRouter = new CommonsRouter(app);

  loadingIndicator = new LoadingIndicator;

  confirmationDialog = new ConfirmationDialog;

  infoDialog = new InfoDialog;

  selectorDialogCommon = new DocumentSelector;

  app.setWidgets();

  app.setListeners();

  app.displayAllCommons(null);

}).call(this);
