#! /bin/sh
# postinst script for newebe
# $Id: newebe.postinst,v 1.0 2012/11/26 21:39:04 hmh Exp $

set -e

HOME_DIR=/var/lib/newebe
LOG_DIR=/var/log/newebe
CONFIG_DIR=/etc/newebe
GROUP=newebe
USER=newebe

case "$1" in
    configure)
        # add newebe system user (requires adduser >= 3.34)
        echo "Creating/updating $USER user account..."
       
        if ! id $USER > /dev/null 2>&1
        then
            addgroup $GROUP
            adduser --system --ingroup $GROUP --home $HOME_DIR \
                    --gecos "Newebe system user" --shell /bin/false \
                    --quiet --disabled-password $USER
        fi
        chown -R newebe:newebe $HOME_DIR

        if [ ! -d $LOG_DIR ]; then
            mkdir -p $LOG_DIR
        fi
        chown -R newebe:newebe $LOG_DIR
        
        if [ ! -d $CONFIG_DIR ]; then
            mkdir -p $CONFIG_DIR 
        fi


        cd $CONFIG_DIR
        if [ ! -d "certs" ]; then
            mkdir certs 
        fi
        
        
        if [ ! -d "certs/server.key" ]; then
            cd certs
            openssl genrsa -out ./server.key 1024
            openssl req -new -x509 -days 3650 -key ./server.key \
                    -out ./server.crt -batch
        
            cd ..
        fi
        chown -R newebe:newebe $CONFIG_DIR/*
        chmod -R 700 $CONFIG_DIR/certs

        touch /usr/share/pyshared/newebe/apps/__init__.py
        touch /usr/share/pyshared/newebe/tools/__init__.py
        touch /usr/share/pyshared/newebe/lib/__init__.py

        echo "
[program:newebe]
autorestart=false
command=newebe_server --configfile=/etc/newebe/config.yaml
redirect_stderr=true
user=newebe
" > /etc/supervisor/conf.d/newebe.conf
        supervisorctl update
        supervisorctl start newebe
        ;;
    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0
